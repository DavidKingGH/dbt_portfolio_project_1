version: 2

models:

- name: mrt__acquisition_device_cohorts
  description: |
    "Calculates monthly user acquisition cohorts based on the device of their first session. It tracks monthly revenue, orders, 
    and purchaser counts for each cohort over time."
  data_tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "orders >= purchasers"
  columns: 
    - name: acquisition_device
      data_tests: 
        - accepted_values: 
            arguments: 
              values: ['mobile', 'tablet', 'desktop']
    - name: acquisition_month
      data_tests: 
        - not_null
    - name: months_since_acquisition
      data_tests: 
        - not_null
        - dbt_utils.expression_is_true:
            arguments: 
              expression: ">=0"
    - name: total_revenue
      data_tests:
        - not_null 
        - dbt_utils.expression_is_true:
            arguments: 
              expression: ">=0"  
    - name: orders
      data_tests:
        - not_null 
        - dbt_utils.expression_is_true:
            arguments: 
              expression: ">=0"  
    - name: purchasers
      data_tests:
        - not_null 
        - dbt_utils.expression_is_true:
            arguments: 
              expression: ">=0"  
- name: mrt__user_device_segments
  description: |
    "Segments users based on their dominant purchasing device and assigns them to a spending quartile relative 
    to other users on the same device type."
  columns: 
    - name: user_id
      data_tests: 
        - not_null
        - unique
        - relationships:
            arguments:
              to: ref('stg__user_orders')
              field: user_id
    - name: dominant_device
      data_tests: 
        - not_null
        - accepted_values: 
            arguments: 
              values: ['mobile', 'tablet', 'desktop']
    - name: total_revenue
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">=0"
    - name: cart_value_quartile
      data_tests:
        - not_null
        - accepted_values: 
            arguments: 
              values: [1,2,3,4]
    - name: segment_name
      data_tests:
        - not_null
- name: mrt__campaign_performance_rev_metrics
  description: |
    "Segments users based on their dominant purchasing device and assigns them to a spending quartile relative 
    to other users on the same device type."
  data_tests:
    - dbt_utils.expression_is_true:
        name: revenue_matches_conversions
        arguments:
          expression: "(converting_users = 0 AND total_revenue = 0) OR (converting_users > 0 AND total_revenue >0)"
          config:
              severity: warn
  columns:
    - name: session_source
      data_tests:
        - not_null
        - dbt_utils.not_empty_string
    - name: session_medium
      data_tests:
        - not_null
        - dbt_utils.not_empty_string
    - name: total_revenue
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">=0"
    - name: total_users
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">=0"
    - name: converting_users
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">=0"
        - dbt_utils.expression_is_true:
            arguments:
              expression: "<= total_users"
    - name: average_order_value
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">=0"
- name: mrt__first_touch_ltv
  description: "..."
  data_tests:
    - dbt_utils.expression_is_true:
        name: avg_ltv_calculation_correct
        arguments:
          expression: "ABS(average_ltv_by_channel - (total_purchase_value_from_cohort / NULLIF(acquired_customers, 0))) < 0.01"
          config:
              severity: warn
    - dbt_utils.expression_is_true:
        name: customers_imply_revenue
        expression: "(acquired_customers > 0 AND total_purchase_value_from_cohort > 0) OR (acquired_customers = 0 AND total_purchase_value_from_cohort = 0)"
        config:
          severity: warn
  columns:
    - name: session_source
      data_tests:
        - not_null
        - dbt_utils.not_empty_string
    - name: session_medium
      data_tests:
        - not_null
        - dbt_utils.not_empty_string
    - name: acquired_customers
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: "> 0"
    - name: total_purchase_value_from_cohort
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">=0"
    - name: average_ltv_by_channel
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">=0"
