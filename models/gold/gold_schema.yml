version: 2

models:

- name: mrt__acquisition_device_cohorts
  description: |
    "Calculates monthly user acquisition cohorts based on the device of their first session. It tracks monthly revenue, orders, 
    and purchaser counts for each cohort over time."
  config: 
    tags: ['gold', 'behavioral_cohorts', 'devices']
    contract: 
      enforced: true

  data_tests:
    - dbt_utils.unique_combination_of_columns:
        combination_of_columns: 
          - acquisition_device
          - acquisition_month
          - months_since_acquisition
    
    - dbt_utils.expression_is_true:
        name: orders_exceed_purchasers
        expression: "orders >= purchasers"
    
    - dbt_utils.expression_is_true:
        name: revenue_matches_orders
        expression: "(orders = 0 AND total_revenue = 0) OR (orders > 0 AND total_revenue > 0)"
        config:
          severity: warn

  columns: 
    - name: acquisition_device
      description: "Device type of user's first session"
      data_type: varchar
      constraints: 
        - type: not_null
      data_tests: 
        - accepted_values: 
            arguments: 
              values: ['mobile', 'tablet', 'desktop']
    - name: acquisition_month
      description: "Month when user first appeared (YYYY-MM-01)"
      data_type: date
      constraints:
        - type: not_null
    - name: months_since_acquisition
      description: "Months elapsed since acquisition (0 = same month)"
      data_type: int
      constraints:
        - type: not_null
      data_tests: 
        - dbt_utils.expression_is_true:
            arguments: 
              expression: ">= 0"
    - name: total_revenue
      description: "Sum of revenue for this cohort-month combination"
      data_type: decimal
      constraints: 
        - type: not_null
      data_tests:
        - dbt_utils.expression_is_true:
            arguments: 
              expression: ">= 0"  
    - name: orders
      description: "Count of orders for this cohort-month combination"
      data_type: int
      constraints: 
        - type: not_null
      data_tests:
        - dbt_utils.expression_is_true:
            arguments: 
              expression: ">= 0"  
    - name: purchasers
      description: "Count of unique users who purchased in this cohort-month"
      data_type: int
      constraints: 
        - type: not_null
      data_tests:
        - dbt_utils.expression_is_true:
            arguments: 
              expression: ">= 0"  

- name: mrt_user_device_segments
  description: |
    "Segments users based on their dominant purchasing device and assigns them to a spending quartile relative 
    to other users on the same device type."
  columns: 
    - name: user_id
      data_tests: 
        - not_null
        - unique
        - relationships:
            arguments:
              to: ref('stg__user_orders')
              field: user_id
    - name: dominant_device
      data_tests: 
        - not_null
        - accepted_values: 
            arguments: 
              values: ['mobile', 'tablet', 'desktop']
    - name: total_revenue
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">=0"
    - name: cart_value_quartile
      data_tests:
        - not_null
        - accepted_values: 
            arguments: 
              values: [1,2,3,4]
    - name: segment_name
      data_tests:
        - not_null
   