version: 2

models:

- name: stg__user_orders
  description: Summarizes the revenue for each item within each purchase event.
  data_tests: 
    - dbt_utils.expression_is_true:
        expression: "total_items >= distinct_products"  
  columns: 
    - name: event_id
      data_tests:
        - unique
        - not_null
        - relationships:
              to: ref('fct_events')
              field: event_id
    - name: order_date
      data_tests: 
        - not null
    - name: user_id
      data_tests:
        - not_null
    - name: ga_session_id
      data_tests:
        - not null
    - name: device_category
      data_tests:
        - accepted_values:
            arguments:
              values: ['desktop', 'mobile', 'tablet']
    - name: revenue
      data_tests:
        - dbt_utils.expression_is_true:
            expression: ">=0"
    - name: total_items
      data_tests:
        - dbt_utils.expression_is_true:
            expression: ">= 1" # An order should have at least one item
    - name: distinct_products
      data_tests:
        - dbt_utils.expression_is_true:
            expression: ">=0" # An order should have at least one distinct item
- name: stg__user_sessions
  description: Summarizes the session information for each session for each user.
  data_tests:
    - dbt_utils.unique_combination_of_columns:
        combination_of_columns: ['user_id', 'ga_session_id']
    - dbt.expression_is_true:
        expression: "session_end_timestamp >= session_start_timestamp"
  columns:
    - name: user_id
      data_tests:
        - not_null
        - relationships: 
            to: ref('fct_events')
            field: user_id
    - name: ga_session_id
      data_tests: 
        - not_null
    - name: session_start_timestamp
      data_tests: 
        - not_null
    - name: session_end_timestamp
      data_tests: 
        - not_null
    - name: device_category
      data_tests:
        - not_null
        - accepted_values:
            arguments:
              values: ['desktop', 'mobile', 'tablet']
    - name: session_source
      data_tests:
        - not_null
    - name: session_medium
      data_tests: 
        - not_null
    - name: landing_page
      data_tests: 
        - not_null
    - name: country
      data_tests: 
        - not_null
    - name: event_count
      data_tests:
        - dbt_utils.expression_is_true: 
            expression: ">0"